name: AWS EKS Infratructure Deployment

on:
    workflow_dispatch:
    
         inputs:
             action:
                 description: 'Terraform action to perform'
                 required: true
                 type: choice
                 default: 'plan'
                 options:
                     - plan
                     - apply
                     - destroy

env:
    AWS_REGION: 'us-east-1'
    TF_VERSION: '1.5.7'
    TF_WORKING_DIR: 'aws_eks_infrastructure/Env/Dev'

jobs:
    terraform-validate:
        name: Terraform Validate!
        runs-on: ubuntu-latest
        environment: ai-APP
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.14.6

            - name: TErraform Format Check
              working-directory: ${{ env.TF_WORKING_DIR }}
              run: terraform fmt -check -recursive
              continue-on-error: true

            - name: Terraform Init (Calidation ONly)
              working-directory: ${{ env.TF_WORKING_DIR }}
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: terraform init -backend=false

            - name: Terraform Validate
              working-directory: ${{ env.TF_WORKING_DIR }}
              run: terraform validate

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: terraform-validate
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run tfsec
              uses: aquasecurity/tfsec-action@v1.0.3
              with:
                working_directory: ${{ env.TF_WORKING_DIR }}
                soft_fail: true

            - name: Run Checkov
              uses: bridgecrewio/checkov-action@master
              with:
                directory: ${{ env.TF_WORKING_DIR }}
                framework: terraform
                soft_fail: true

    terraform-plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        needs: [terraform-validate, security-scan]
        environment: ai-APP
        outputs:
            plan-exitcode: ${{ steps.plan.outputs.exitcode }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Init
              working-directory: ${{ env.TF_WORKING_DIR }}
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                terraform plan \
                  -var="region=${{ env.AWS_REGION }}" \
                  -out=tfplan \
                  -no-color | tee plan.txt
                echo "exitcode=$?" >> $GITHUB_OUTPUT

            - name: Upload Plan Artifact
              uses: actions/upload-artifact@v4
              with:
                name: terraform-plan-development-${{ github.run_number }}
                path: |
                  ${{ env.TF_WORKING_DIR }}/tfplan
                  ${{ env.TF_WORKING_DIR }}/plan.txt
                retention-days: 7

    terraform-apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: terraform-plan
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        environment:
            name: ai-APP # This references your Github environemnt where sectrts are stored
            url: https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}
        steps:
            - name: checkout Code
              uses: actions/checkout@v4

            - name: setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ env.TF_VERSION }}

            - name: Download Plan Artifact
              uses: actions/download-artifact@v4
              with:
                name: terraform-plan-development-${{ github.run_number }}
                path: ${{ env.TF_WORKING_DIR }}

            - name: Terraform Plan
              working-directory: ${{ env.TF_WORKING_DIR }}
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                terraform plan \
                  -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
                  -backend-config="key=developement/terraform.tfstate" \
                  -backend-config="region=${{ env.AWS_REGION }}"
                  
            - name: Terraform Apply
              working-directory: ${{ env.TF_WORKING_DIR }}
              env:
                TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
                TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: terraform apply -auto-approve tfplan

            - name: Get Terraform Outputs
              id: outputs
              working-directory: ${{ env.TF_WORKING_DIR }}
              run: |
                echo "cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
                echo "cluster_endpoint=$(terraform output -raw cluster_endpoint 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
                echo "vpc_id=$(terraform output -raw vpc_id 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
                echo "ecr_repository_url=$(terraform output -raw ecr_repository_url 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
                
            - name: Create Deployment Summary
              run: |
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                ## Deployment Summary - Development Environment

                ## Infrastructure Details
                - **Environment**: `development`
                - **Cluster Name**: `${{ steps.outputs.outputs.cluster_name }}`
                - **Cluster Endpoint**: `${{ steps.outputs.outputs.cluster_endpoint }}`
                - **VPC id**: `${{ steps.outputs.outputs.vpc_id }}`
                - **ECR Repository**: `${{ steps.outputs.outputs.ecr_repository_url }}`
                - **Region**: `${{ env.AWS_REGION }}`
                - **Deployed By**: @${{ github.actor }}
                - **Commit**: `${{ github.sha }}`

                ### AWS Console Links
                - [EKS Cluster Console](https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters/${{ steps.outputs.outputs.cluster_name }})
                - [VPC Console](https://console.aws.amazon.com/vpc/home?region=${{ env.AWS_REGION }}#vpcs:VpcId=${{ steps.outputs.outputs.vpc_id }})
                - [ECR Console](https://console.aws.amazon.com/ecr/repositories?region=${{ env.AWS_REGION }})
                
                ### Deployment Status
                âœ… Infrastructure deployed successfully
                EOF

    terraform-destroy:
        name: Terraform Destroy
        runs-on: ubuntu-latest
        needs: terraform-validate
        if: github.event.inputs.action == 'destroy'
        environment: 
            name: ai-APP-destroy # Seperate environoment for destroy (you can add approval protection)
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Init
              working-directory: ${{ env.TF_WORKING_DIR }}
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                terraform init \
                  -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
                  -backend-config="key=development/terraform.tfstate" \
                  -backend-config="region=${{ env.AWS_REGION }}"

            - name: Terraform Destroy
              working-directory: ${{ env.TF_WORKING_DIR }}
              env:
                TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
                TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                terraform destroy -auto-approve \
                  -var="region=${{ env.AWS_REGION }}"

            - name: Destroy Summary
              run: |
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                ## ðŸ—‘ï¸ Infrastructure Destroyed - Development Environment
                
                - **Environment**: `development`
                - **Region**: `${{ env.AWS_REGION }}`
                - **Destroyed By**: @${{ github.actor }}
                - **Timestamp**: $(date)
                
                âš ï¸ All resources in this environment have been destroyed.
                EOF

    notify-success:
      name: Deployment Success Notification
      runs-on: ubuntu-latest
      needs: terraform-apply
      if: success()
      steps:
        - name: Success Notification
          run: |
            echo "âœ… Deployment to development environment completed successfully!"

    notify-failure:
      name: Deployment Failure Notification
      runs-on: ubuntu-latest
      needs: terraform-apply
      if: failure()
      steps:
        - name: Failure Notification
          run: |
            echo "âŒ Deployment to development environment failed!"
            echo "Check the workflow logs for details."
